<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Interfaz ESP32 + Google Sheets</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    button { margin: 5px; padding: 8px 12px; }
    ul { list-style-type: none; padding: 0; }
    li { cursor: pointer; margin: 4px 0; padding: 6px; background: #f0f0f0; }
    li:hover { background: #d0e0ff; }
    label { display: block; margin: 6px 0; }
    input { width: 200px; }
    #detalle { margin-top: 20px; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>

  <h2>Gestión de Tanques con ESP32-S3</h2>

  <!-- Botón para conectar Bluetooth -->
  <button onclick="conectarBluetooth()">Conectar ESP32-S3</button>
  <p id="estadoBT">Estado Bluetooth: Desconectado</p>
  <p>Última señal transmisor: <span id="senal"></span></p>

  <!-- Bloque de Google Sheets -->
  <button onclick="verLista()">Ver lista de tanques</button>
  <div id="lista"></div>
  <div id="detalle"></div>

  <script>
    // URL de tu Web App en Google Apps Script
    const urlSheets = "https://script.google.com/macros/s/AKfycbzg78gvr2sxCmRJpW14PmLnssqhWzTtRlpJGD2u-Sy12Ehd4byvaEP4h4MkdDgey1Iw/exec";

    // -------------------------------
    // BLOQUE A: Bluetooth ESP32-S3
    // -------------------------------
    let dispositivoBT;
    let caracteristica;

    async function conectarBluetooth() {
      try {
        dispositivoBT = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['battery_service'] // cambia por tu UUID si lo tienes
        });
        const server = await dispositivoBT.gatt.connect();
        document.getElementById("estadoBT").innerText = "Estado Bluetooth: Conectado";

        // Ejemplo: leer característica
        const service = await server.getPrimaryService('battery_service');
        caracteristica = await service.getCharacteristic('battery_level');

        caracteristica.startNotifications();
        caracteristica.addEventListener('characteristicvaluechanged', manejarDatos);

      } catch (error) {
        console.error("Error Bluetooth:", error);
      }
    }

    function manejarDatos(event) {
      let valor = event.target.value.getUint8(0); // ejemplo simple
      document.getElementById("senal").innerText = valor;
      // Opcional: actualizar automáticamente SENSOR/ESTADO del tanque seleccionado
      if (document.getElementById("sensor")) {
        document.getElementById("sensor").value = valor;
        document.getElementById("estado").value = "Activo";
      }
    }

    // -------------------------------
    // BLOQUE B: Google Sheets
    // -------------------------------
    function verLista() {
      fetch(urlSheets)
        .then(res => res.json())
        .then(data => {
          let html = "<h3>Lista de tanques</h3><ul>";
          data.forEach(tanque => {
            html += `<li onclick="verDetalle('${tanque.TK}')">${tanque.TK}</li>`;
          });
          html += "</ul>";
          document.getElementById("lista").innerHTML = html;
          window.tanques = data;
        })
        .catch(err => console.error("Error al cargar lista:", err));
    }

    function verDetalle(nombre) {
      let tanque = window.tanques.find(t => t.TK === nombre);
      let html = `
        <h3>Tanque: ${tanque.TK}</h3>
        <label>Volumen: <input id="volumen" value="${tanque.VOLUMEN}"></label>
        <label>Diámetro: <input id="diametro" value="${tanque.DIAMETRO}"></label>
        <label>Altura: <input id="altura" value="${tanque.ALTURA}"></label>
        <label>Densidad: <input id="densidad" value="${tanque.DENSIDAD}"></label>
        <label>Sensor: <input id="sensor" value="${tanque.SENSOR}"></label>
        <label>Estado: <input id="estado" value="${tanque.ESTADO}"></label>
        <button onclick="guardar('${tanque.TK}')">Guardar cambios</button>
      `;
      document.getElementById("detalle").innerHTML = html;
    }

    function guardar(nombre) {
      let data = {
        TK: nombre,
        VOLUMEN: document.getElementById("volumen").value,
        DIAMETRO: document.getElementById("diametro").value,
        ALTURA: document.getElementById("altura").value,
        DENSIDAD: document.getElementById("densidad").value,
        SENSOR: document.getElementById("sensor").value,
        ESTADO: document.getElementById("estado").value
      };

      fetch(urlSheets, {
        method: "POST",
        body: JSON.stringify(data),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.text())
      .then(msg => alert("Guardado: " + msg))
      .catch(err => console.error("Error al guardar:", err));
    }
  </script>

</body>
</html>
