<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Tanques</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 15px; border-top: 5px solid #1a73e8; }
        .card-calib { border-top: 5px solid #ef6c00; position: relative; }
        .locked { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .lock-overlay { position: absolute; top:0; left:0; width:100%; height:100%; display:none; align-items:center; justify-content:center; background: rgba(255,255,255,0.6); z-index: 10; font-weight: bold; color: #d32f2f; }
        
        h3 { margin: 0 0 10px 0; font-size: 0.9em; text-align: center; text-transform: uppercase; }
        .grid-datos { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .box-edit { background: #f8f9fa; border: 1px solid #ddd; padding: 5px 8px; border-radius: 8px; }
        .label { font-size: 0.65em; color: #666; font-weight: bold; text-transform: uppercase; display: block; }
        .input-edit { width: 100%; border: none; background: transparent; color: #1a73e8; font-weight: bold; font-size: 14px; padding: 2px 0; outline: none; }
        
        select { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #1a73e8; font-size: 16px; margin-bottom: 15px; }
        .btn { width: 100%; padding: 15px; border-radius: 10px; border: none; font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 8px; }
        .btn-calibrar { background: #ef6c00; color: white; }
        .btn-finalizar { background: #d32f2f; color: white; display: none; }
        .btn-save { background: #2e7d32; color: white; }
        .btn-ble { background: #455a64; color: white; }
        
        #display-kg { font-size: 3em; font-weight: bold; text-align: center; color: #1a73e8; }
        .badge-calibrado { background: #c8e6c9; color: #2e7d32; padding: 4px 8px; border-radius: 5px; font-size: 10px; display: none; }
    </style>
</head>
<body>

    <div class="card card-calib" id="panelCalib">
        <div id="lockMsg" class="lock-overlay">üîí TANQUE YA CALIBRADO</div>
        <h3>‚öôÔ∏è PROCESO DE CALIBRACI√ìN</h3>
        
        <div style="text-align: center; margin-bottom: 10px;">
            <span id="badgeCal" class="badge-calibrado">CALIBRADO</span>
        </div>

        <div id="controlesCalib">
            <button id="btnIniciarCal" class="btn btn-calibrar" onclick="iniciarCalibracion()">üèóÔ∏è EMPEZAR CALIBRACI√ìN</button>
            
            <div id="zonaPasos" style="display:none; margin-top: 10px; text-align: center; background: #fff3e0; padding: 10px; border-radius: 8px;">
                <span class="label">Peso Inicial Guardado</span>
                <span id="v-congelado" style="font-size:1.4em; font-weight:bold; color:#e65100;">0.00 g</span>
                <hr>
                <span class="label">Diferencia de Columna (Œî)</span>
                <span id="v-delta" style="font-size:1.8em; font-weight:bold; color:#bf360c;">0.00 g</span>
                <button class="btn btn-finalizar" id="btnFinCal" onclick="finalizarCalibracion()">‚úÖ FINALIZAR Y MARCAR CALIBRADO</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>üìã DATOS DEL TANQUE</h3>
        <select id="listaTanques" onchange="cambiarTanque()">
            <option>Cargando lista...</option>
        </select>
        
        <div class="grid-datos">
            <div class="box-edit"><span class="label">Densidad</span><input id="e-dens" class="input-edit" type="text"></div>
            <div class="box-edit"><span class="label">Sensor</span><input id="e-sens" class="input-edit" type="text"></div>
            <div class="box-edit"><span class="label">Estado</span><span id="v-est" class="value" style="font-weight:bold; color:red;">-</span></div>
            <div class="box-edit"><span class="label">Capacidad</span><input id="e-cap" class="input-edit" type="text"></div>
            <div class="box-edit"><span class="label">Altura m</span><span id="v-altura" class="value" style="font-weight:bold;">0.00</span></div>
            <div class="box-edit"><span class="label">Peso Col. g</span><span id="v-cruda" class="value" style="font-weight:bold;">0</span></div>
        </div>

        <div id="display-kg">0.00 kg</div>

        <button class="btn btn-save" onclick="enviarExcel()">üíæ ACTUALIZAR PESO ACTUAL</button>
        <button class="btn btn-ble" onclick="conectarBLE()">üîó CONECTAR SENSOR</button>
    </div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwrFaJIkebV9PmlyLmefrH5rLffGoQo_xDSJCu2TaAsLHXtWSulgrGKBFhQ3UMQd2z3/exec";
    let pesoActualColumna = 0;
    let pesoReferenciaColumna = 0;
    let datosExcel = [];
    let enModoCalibracion = false;

    async function cargarTanques() {
        const r = await fetch(SCRIPT_URL);
        datosExcel = await r.json();
        let opciones = "";
        datosExcel.forEach((fila, i) => { opciones += `<option value="${i}">${fila[0]}</option>`; });
        document.getElementById('listaTanques').innerHTML = opciones;
        cambiarTanque();
    }

    function cambiarTanque() {
        const i = document.getElementById('listaTanques').value;
        const t = datosExcel[i];
        if (!t) return;

        // Cargar datos
        document.getElementById('e-dens').value = t[1] || "";
        document.getElementById('e-sens').value = t[2] || "";
        document.getElementById('v-est').innerText = t[4] || "";
        document.getElementById('e-cap').value = t[7] || "";

        // L√≥gica de bloqueo
        const estado = (t[4] || "").toLowerCase();
        if (estado === "calibrado") {
            document.getElementById('panelCalib').classList.add('locked');
            document.getElementById('lockMsg').style.display = 'flex';
            document.getElementById('badgeCal').style.display = 'inline-block';
            document.getElementById('zonaPasos').style.display = 'none';
        } else {
            document.getElementById('panelCalib').classList.remove('locked');
            document.getElementById('lockMsg').style.display = 'none';
            document.getElementById('badgeCal').style.display = 'none';
            document.getElementById('btnIniciarCal').style.display = 'block';
        }
        actualizarCalculos();
    }

    function iniciarCalibracion() {
        enModoCalibracion = true;
        pesoReferenciaColumna = pesoActualColumna;
        document.getElementById('v-congelado').innerText = pesoReferenciaColumna.toFixed(2) + " g";
        document.getElementById('btnIniciarCal').style.display = 'none';
        document.getElementById('zonaPasos').style.display = 'block';
        document.getElementById('btnFinCal').style.display = 'block';
        alert("Calibraci√≥n Iniciada: Mueva el l√≠quido para ver la diferencia.");
    }

    function finalizarCalibracion() {
        if(confirm("¬øDeseas marcar este tanque como CALIBRADO en el sistema?")) {
            const i = document.getElementById('listaTanques').value;
            const payload = {
                fila: parseInt(i) + 2,
                columnaEstado: 5, // Columna E (Estado)
                valorEstado: "CALIBRADO"
            };
            
            // Aqu√≠ enviamos la se√±al de calibrado
            fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) })
            .then(() => {
                alert("Tanque Calibrado Exitosamente.");
                cargarTanques(); // Recargar para bloquear
            });
        }
    }

    function actualizarCalculos() {
        document.getElementById('v-cruda').innerText = pesoActualColumna.toFixed(2);
        
        if (enModoCalibracion) {
            let delta = pesoActualColumna - pesoReferenciaColumna;
            document.getElementById('v-delta').innerText = delta.toFixed(2) + " g";
        }

        let dens = parseFloat(document.getElementById('e-dens').value) || 0.85;
        let altura = ((pesoActualColumna / 1000) * 9.81) / (0.00114 * dens * 1000 * 9.81);
        document.getElementById('v-altura').innerText = altura.toFixed(2);
        document.getElementById('display-kg').innerText = (pesoActualColumna * 1.5).toFixed(2) + " kg";
    }

    async function conectarBLE() {
        const device = await navigator.bluetooth.requestDevice({
            filters: [{ namePrefix: 'TANQUE' }],
            optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
        const char = await service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');
        await char.startNotifications();
        char.addEventListener('characteristicvaluechanged', (e) => {
            pesoActualColumna = parseFloat(new TextDecoder().decode(e.target.value));
            actualizarCalculos();
        });
    }

    function enviarExcel() {
        const i = document.getElementById('listaTanques').value;
        const payload = {
            fila: parseInt(i) + 2,
            valor: document.getElementById('display-kg').innerText.replace(" kg", "")
        };
        fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) })
        .then(() => alert("‚úÖ Peso actualizado en Excel"));
    }

    window.onload = cargarTanques;
</script>
</body>
</html>
