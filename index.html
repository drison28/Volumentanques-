<!DOCTYPE html>
<html lang="
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Calibraci√≥n y Control</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f4f8; margin: 0; padding: 10px; }
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; border-top: 5px solid #1a73e8; }
        h3 { margin: 0 0 10px 0; color: #1a73e8; font-size: 1em; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: #f8f9fa; padding: 10px; border-radius: 8px; }
        .label { font-size: 10px; colo666; font-weight: bold; }
        .value { font-size: 13px; color: #1a73e8; font-weight: 600; }
        .calib-box { background: #fff3e0; border: 1px solid #ffcc80; padding: 10px; border-radius: 8px; margin-top: 10px; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-calc { background: #ef6c00; color: white; }
        .btn-save { background: #2e7d32; color: white; }
        .btn-ble { background: #546e7a; color: white; }
        #lectura-kg { font-size: 3em; font-weight: bold; color: #1a73e8; text-align: center; margin: 10px 0; }
        input { width: 90%; padding: 5px; border-radius: 4px; border: 1px solid #ccc; font-size: 13px; }
    </style>
</head>
<body>

    <div class="card" style="border-top-color: #ef6c00;">
        <h3>‚öôÔ∏è PANEL DE CALIBRACI√ìN</h3>
        <div class="info-grid">
            <div>
                <span class="label">L√≠quido:</span><br>
                <input type="text" id="c-liquido" value="Diesel">
            </div>
            <div>
                <span class="label">Di√°metro Sensor (pulg):</span><br>
                <input type="number" id="c-diam-sensor" value="1.5" step="0.1" onchange="actualizarArea()">
            </div>
            <div>
                <span class="label">Se√±al Cruda:</span><br>
                <span id="c-peso-actual" class="value">0 g</span>
            </div>
            <div>
                <span class="label">Densidad:</span><br>
                <input type="number" id="c-densidad" value="0.85" step="0.01">
            </div>
        </div>

        <div class="calib-box">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <div>
                    <span class="label">PESO INICIAL:</span><br>
                    <span id="v-congelado" style="font-size:18px; font-weight:bold; color:#e65100;">0.00 g</span>
                </div>
                <button class="btn btn-calc" style="width:45%;" onclick="congelarSe√±al()">‚ùÑÔ∏è CAPTURAR INICIO</button>
            </div>
            
            <div style="margin-top:10px; border-top: 1px dashed #ffcc80; padding-top:10px;">
                <span class="label">DIFERENCIA (Œî):</span>
                <div id="v-diferencia" style="font-size:20px; font-weight:bold; color:#d84315;">0.00 g</div>
                <span class="label" id="txt-operacion">Esperando movimiento de l√≠quido...</span>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>üìä CONTROL DE VOLUMEN (KG)</h3>
        <select id="listaTanques" onchange="mostrarDetalles()" style="width:100%; padding:10px; margin-bottom:10px;">
            <option>Cargando tanques...</option>
        </select>
        
        <div id="lectura-kg">0.00 kg</div>
        
        <div class="info-grid">
            <div><span class="label">Altura Est.:</span> <span id="v-altura" class="value">0.00 m</span></div>
            <div><span class="label">Di√°metro Est.:</span> <span id="v-diam-tanque" class="value">0.00 m</span></div>
        </div>

        <button class="btn btn-save" onclick="enviarExcel()">üíæ ACTUALIZAR EN GOOGLE SHEETS</button>
        <button class="btn btn-ble" onclick="conectarBLE()">üîó VINCULAR ESP32-S3</button>
    </div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwrFaJIkebV9PmlyLmefrH5rLffGoQo_xDSJCu2TaAsLHXtWSulgrGKBFhQ3UMQd2z3/exec";
    let pesoActual = 0;
    let pesoCongelado = 0;
    let areaSensorM2 = 0.00114; // Por defecto 1.5 pulgadas

    function actualizarArea() {
        let dPulg = document.getElementById('c-diam-sensor').value;
        let radioM = (dPulg * 0.0254) / 2;
        areaSensorM2 = Math.PI * Math.pow(radioM, 2);
    }

    function congelarSe√±al() {
        pesoCongelado = pesoActual;
        document.getElementById('v-congelado').innerText = pesoCongelado.toFixed(2) + " g";
        alert("Se√±al inicial congelada. Procede a cargar o descargar l√≠quido.");
    }

    function calcularIngenieria() {
        let dens = parseFloat(document.getElementById('c-densidad').value);
        
        // 1. Mostrar se√±al cruda en panel calibraci√≥n
        document.getElementById('c-peso-actual').innerText = pesoActual.toFixed(2) + " g";

        // 2. Calcular Diferencia
        let diferencia = pesoActual - pesoCongelado;
        document.getElementById('v-diferencia').innerText = diferencia.toFixed(2) + " g";
        document.getElementById('txt-operacion').innerText = diferencia >= 0 ? "üìà SUMINISTRANDO..." : "üìâ SACANDO...";

        // 3. C√°lculo de Volumen en KG (Usando factor de conversi√≥n o presi√≥n)
        // Por ahora asumo 1g de presi√≥n = 1.2kg de producto (Ajustar seg√∫n tu prueba)
        let volumenKg = pesoActual * 1.2; 
        document.getElementById('lectura-kg').innerText = volumenKg.toFixed(2) + " kg";

        // 4. Altura hidrost√°tica (h = P / (rho * g))
        let fuerza = (pesoActual / 1000) * 9.81;
        let presionPa = fuerza / areaSensorM2;
        let altura = presionPa / (dens * 1000 * 9.81);
        document.getElementById('v-altura').innerText = altura.toFixed(2) + " m";

        // 5. Estimaci√≥n de Di√°metro Tanque (Si hay diferencia de peso conocida)
        // Esta parte es para cuando t√∫ sepas cu√°ntos kg reales echaste
        if(Math.abs(diferencia) > 5) {
             // L√≥gica para estimar di√°metro basada en el cambio de altura vs litros reales
             document.getElementById('v-diam-tanque').innerText = "Calculando...";
        }
    }

    // --- FUNCIONES BLUETOOTH Y EXCEL IGUALES A LAS ANTERIORES ---
    async function conectarBLE() {
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'TANQUE' }],
                optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
            const char = await service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');
            document.getElementById('status-ble').innerText = "Conectado";
            await char.startNotifications();
            char.addEventListener('characteristicvaluechanged', (e) => {
                pesoActual = parseFloat(new TextDecoder().decode(e.target.value));
                calcularIngenieria();
            });
        } catch (e) { alert("Error BLE"); }
    }

    async function cargarTanques() {
        const r = await fetch(SCRIPT_URL);
        const baseDatos = await r.json();
        let html = "";
        baseDatos.forEach((t, i) => { html += `<option value="${i}">${t[0]}</option>`; });
        document.getElementById('listaTanques').innerHTML = html;
    }

    function enviarExcel() {
        const i = document.getElementById('listaTanques').value;
        const val = document.getElementById('lectura-kg').innerText.replace(" kg", "");
        fetch(SCRIPT_URL, {
            method: "POST", mode: "no-cors",
            body: JSON.stringify({ fila: parseInt(i) + 2, valor: val })
        }).then(() => alert("‚úÖ Guardado"));
    }

    window.onload = () => { cargarTanques(); actualizarArea(); };
</script>
</body>
</html>
