<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero Control Tanques</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f9; margin: 0; padding: 15px; }
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 5px solid #1a73e8; }
        h3 { margin: 0 0 15px 0; color: #1a73e8; font-size: 1.1em; display: flex; align-items: center; }
        select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #d1d9e0; font-size: 16px; margin-bottom: 15px; background: #fff; }
        .btn { width: 100%; padding: 15px; border-radius: 10px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-ble { background: #f2994a; color: white; margin-bottom: 10px; }
        .btn-save { background: #27ae60; color: white; }
        
        /* Cuadro de InformaciÃ³n Estilo Rejilla */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #eef6ff; padding: 15px; border-radius: 10px; border: 1px solid #bbdefb; }
        .info-item { display: flex; flex-direction: column; border-bottom: 1px solid #d0e3f5; padding-bottom: 5px; }
        .full-width { grid-column: span 2; border-bottom: 2px solid #bbdefb; margin-bottom: 5px; }
        .label { font-size: 10px; color: #5f6368; text-transform: uppercase; font-weight: bold; }
        .value { font-size: 14px; color: #1a73e8; font-weight: 600; }
        
        #lectura-grande { font-size: 3.2em; font-weight: bold; color: #1a73e8; text-align: center; margin: 15px 0; }
        #peso-small { text-align: center; color: #70757a; font-size: 0.9em; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <h3>ðŸ“¡ DISPOSITIVO</h3>
        <button class="btn btn-ble" onclick="conectarBLE()">ðŸ”— VINCULAR ESP32-S3</button>
        <div id="status-ble" style="text-align:center; font-size:12px; color:#666;">Estado: âšª Desconectado</div>
    </div>

    <div class="card">
        <h3>ðŸ“‹ DATOS DEL TANQUE</h3>
        <select id="listaTanques" onchange="mostrarDetalles()">
            <option>Cargando informaciÃ³n...</option>
        </select>
        
        <div class="info-grid">
            <div class="info-item full-width">
                <span class="label">NOMBRE DEL TANQUE</span>
                <span id="v-nombre" class="value">-</span>
            </div>
            <div class="info-item">
                <span class="label">VOLUMEN ACTUAL</span>
                <span id="v-vol" class="value">-</span>
            </div>
            <div class="info-item">
                <span class="label">DENSIDAD</span>
                <span id="v-dens" class="value">-</span>
            </div>
            <div class="info-item">
                <span class="label">SENSOR</span>
                <span id="v-sens" class="value">-</span>
            </div>
            <div class="info-item">
                <span class="label">COMUNICACIÃ“N</span>
                <span id="v-com" class="value">-</span>
            </div>
            <div class="info-item full-width" style="border:none;">
                <span class="label">ESTADO</span>
                <span id="v-est" class="value">-</span>
            </div>
        </div>
    </div>

    <div class="card" style="border-top-color: #27ae60;">
        <h3>ðŸ“Š NUEVA MEDICIÃ“N</h3>
        <div id="lectura-grande">0.00 L</div>
        <div id="peso-small">Peso detectado: 0 g</div>
        <button class="btn btn-save" id="btnGuardar" onclick="enviarExcel()">ðŸ’¾ ACTUALIZAR EN EXCEL</button>
    </div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwrFaJIkebV9PmlyLmefrH5rLffGoQo_xDSJCu2TaAsLHXtWSulgrGKBFhQ3UMQd2z3/exec";
    let baseDatos = [];
    let calculado = 0;

    async function cargarTanques() {
        try {
            const r = await fetch(SCRIPT_URL);
            baseDatos = await r.json();
            let html = "";
            baseDatos.forEach((t, i) => { html += `<option value="${i}">${t[0]}</option>`; });
            document.getElementById('listaTanques').innerHTML = html;
            mostrarDetalles();
        } catch (e) { alert("Error al conectar con Google Sheets"); }
    }

    function mostrarDetalles() {
        const i = document.getElementById('listaTanques').value;
        const t = baseDatos[i];
        // AsignaciÃ³n de columnas del Excel (A=0, B=1, C=2, D=3, E=4, G=6)
        document.getElementById('v-nombre').innerText = t[0] || "N/A";
        document.getElementById('v-dens').innerText   = t[1] || "N/A";
        document.getElementById('v-sens').innerText   = t[2] || "N/A";
        document.getElementById('v-com').innerText    = t[3] || "N/A";
        document.getElementById('v-est').innerText    = t[4] || "N/A";
        document.getElementById('v-vol').innerText    = (t[6] || "0") + " L";
    }

    async function conectarBLE() {
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'TANQUE' }],
                optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
            const char = await service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');
            document.getElementById('status-ble').innerHTML = "ðŸŸ¢ Conectado: " + device.name;
            await char.startNotifications();
            char.addEventListener('characteristicvaluechanged', (e) => {
                const peso = parseFloat(new TextDecoder().decode(e.target.value));
                document.getElementById('peso-small').innerText = "Peso detectado: " + peso + " g";
                // AquÃ­ va tu fÃ³rmula personalizada:
                calculado = (peso * 1.5); 
                document.getElementById('lectura-grande').innerText = calculado.toFixed(2) + " L";
            });
        } catch (err) { alert("Error de Bluetooth"); }
    }

    function enviarExcel() {
        const i = document.getElementById('listaTanques').value;
        const fila = parseInt(i) + 2;
        const btn = document.getElementById('btnGuardar');
        btn.innerText = "ENVIANDO...";
        btn.disabled = true;
        fetch(SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify({ fila: fila, valor: calculado.toFixed(2) })
        }).then(() => {
            alert("âœ… Â¡Dato guardado en el Excel!");
            btn.innerText = "ðŸ’¾ ACTUALIZAR EN EXCEL";
            btn.disabled = false;
            cargarTanques();
        });
    }
    window.onload = cargarTanques;
</script>
</body>
</html>
