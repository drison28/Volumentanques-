<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingenier√≠a de Tanques - Hidrost√°tica</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 15px; border-top: 5px solid #1a73e8; }
        .card-calib { border-top: 5px solid #ef6c00; background: #fffaf5; }
        h3 { margin: 0 0 10px 0; font-size: 1em; color: #333; text-align: center; text-transform: uppercase; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .box { background: #fff; border: 1px solid #ddd; padding: 8px; border-radius: 8px; }
        .label { font-size: 0.7em; color: #666; font-weight: bold; text-transform: uppercase; }
        .value { font-size: 13px; color: #1a73e8; font-weight: bold; display: block; }
        input, select { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 15px; }
        .btn { width: 100%; padding: 15px; border-radius: 10px; border: none; font-size: 15px; font-weight: bold; cursor: pointer; margin-top: 8px; }
        .btn-freeze { background: #ef6c00; color: white; }
        .btn-save { background: #2e7d32; color: white; }
        .btn-ble { background: #455a64; color: white; }
        #display-kg { font-size: 3.5em; font-weight: bold; text-align: center; color: #1a73e8; margin: 10px 0; }
        .delta-box { text-align: center; padding: 10px; background: #ffe0b2; border-radius: 8px; border: 2px dashed #fb8c00; }
    </style>
</head>
<body>

    <div class="card card-calib">
        <h3>‚öôÔ∏è CALIBRACI√ìN DE COLUMNA (PRESI√ìN)</h3>
        <div class="grid">
            <div class="box">
                <span class="label">Peso Columna Actual</span>
                <span id="v-cruda" class="value" style="font-size:1.4em;">0 g</span>
            </div>
            <div class="box">
                <span class="label">Tubo Sensor</span>
                <input type="number" id="c-tubo" value="1.5" step="0.1">
            </div>
        </div>

        <div class="delta-box">
            <span class="label">Referencia Inicial de Columna</span>
            <span id="v-congelado" class="value" style="color:#e65100; font-size:1.2em;">0.00 g</span>
            <button class="btn btn-freeze" onclick="congelar()">‚ùÑÔ∏è CONGELAR SE√ëAL INICIAL</button>
            <hr style="border: 0.5px solid #fb8c00; margin: 10px 0;">
            <span class="label">Diferencia en Columna (Œî)</span>
            <span id="v-delta" style="font-size:1.8em; font-weight:bold; color:#bf360c;">0.00 g</span>
        </div>
    </div>

    <div class="card">
        <h3>üìã DATOS DEL TANQUE Y VOLUMEN</h3>
        <select id="listaTanques" onchange="cambiarTanque()" style="margin-bottom:10px; font-weight:bold;">
            <option>Cargando lista...</option>
        </select>
        
        <div class="grid">
            <div class="box"><span class="label">Densidad</span><span id="v-dens" class="value">-</span></div>
            <div class="box"><span class="label">Sensor</span><span id="v-sens" class="value">-</span></div>
            <div class="box"><span class="label">Comunicaci√≥n</span><span id="v-com" class="value">-</span></div>
            <div class="box"><span class="label">Estado</span><span id="v-est" class="value">-</span></div>
        </div>

        <div id="display-kg">0.00 kg</div>

        <div class="grid">
            <div class="box"><span class="label">Altura L√≠quido</span><span id="v-altura" class="value">0.00 m</span></div>
            <div class="box"><span class="label">Di√°metro Calc.</span><span id="v-diam" class="value">Calculando...</span></div>
        </div>

        <button class="btn btn-save" onclick="enviarExcel()">üíæ GUARDAR KG EN EXCEL</button>
        <button class="btn btn-ble" onclick="conectarBLE()">üîó VINCULAR SENSOR ESP32</button>
    </div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwrFaJIkebV9PmlyLmefrH5rLffGoQo_xDSJCu2TaAsLHXtWSulgrGKBFhQ3UMQd2z3/exec";
    let pesoActualColumna = 0;
    let pesoReferenciaColumna = 0;
    let datosExcel = [];

    async function cargarTanques() {
        try {
            const r = await fetch(SCRIPT_URL);
            datosExcel = await r.json();
            let opciones = "";
            datosExcel.forEach((fila, i) => { opciones += `<option value="${i}">${fila[0]}</option>`; });
            document.getElementById('listaTanques').innerHTML = opciones;
            cambiarTanque();
        } catch (e) { alert("Error al cargar lista"); }
    }

    function cambiarTanque() {
        const i = document.getElementById('listaTanques').value;
        const t = datosExcel[i];
        if (t) {
            document.getElementById('v-dens').innerText = t[1] || "-";
            document.getElementById('v-sens').innerText = t[2] || "-";
            document.getElementById('v-com').innerText = t[3] || "-";
            document.getElementById('v-est').innerText = t[4] || "-";
            actualizarCalculos();
        }
    }

    function congelar() {
        pesoReferenciaColumna = pesoActualColumna;
        document.getElementById('v-congelado').innerText = pesoReferenciaColumna.toFixed(2) + " g";
    }

    function actualizarCalculos() {
        document.getElementById('v-cruda').innerText = pesoActualColumna.toFixed(2) + " g";
        
        // Diferencia de peso en la COLUMNA del sensor
        let deltaColumna = pesoActualColumna - pesoReferenciaColumna;
        document.getElementById('v-delta').innerText = deltaColumna.toFixed(2) + " g";

        // F√≠sica (Altura)
        let dens = parseFloat(document.getElementById('v-dens').innerText) || 0.85;
        let pulg = parseFloat(document.getElementById('c-tubo').value);
        let radioM = (pulg * 0.0254) / 2;
        let areaSensor = Math.PI * Math.pow(radioM, 2);
        let fuerza = (pesoActualColumna / 1000) * 9.81;
        let presion = fuerza / areaSensor;
        let altura = presion / (dens * 1000 * 9.81);
        
        document.getElementById('v-altura').innerText = altura.toFixed(2) + " m";

        // VOLUMEN DEL TANQUE (Resultado final en KG)
        // Aqu√≠ es donde usaremos la diferencia del sensor para calcular el volumen real
        let volumenTotalKg = pesoActualColumna * 1.5; // Factor de ejemplo
        document.getElementById('display-kg').innerText = volumenTotalKg.toFixed(2) + " kg";
    }

    async function conectarBLE() {
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'TANQUE' }],
                optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
            const char = await service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');
            await char.startNotifications();
            char.addEventListener('characteristicvaluechanged', (e) => {
                pesoActualColumna = parseFloat(new TextDecoder().decode(e.target.value));
                actualizarCalculos();
            });
        } catch (e) { alert("Error BLE"); }
    }

    function enviarExcel() {
        const i = document.getElementById('listaTanques').value;
        const valorKg = document.getElementById('display-kg').innerText.replace(" kg", "");
        fetch(SCRIPT_URL, {
            method: "POST", mode: "no-cors",
            body: JSON.stringify({ fila: parseInt(i) + 2, valor: valorKg })
        }).then(() => alert("‚úÖ Guardado"));
    }

    window.onload = cargarTanques;
</script>
</body>
</html>
